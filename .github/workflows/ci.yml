name: cloudkv-ci

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  http-mvp:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Temurin JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build distribution
        run: ./gradlew --no-daemon :modules:api-rest:installDist

      - name: Start server
        run: |
          chmod +x modules/api-rest/build/install/api-rest/bin/api-rest
          nohup modules/api-rest/build/install/api-rest/bin/api-rest > server.log 2>&1 &
          echo $! > server.pid
          sleep 2
          ps aux | grep api-rest

      - name: Wait for health
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8080/health | grep -qi 'up'; then
              echo "✅ Server healthy"
              exit 0
            fi
            echo "Waiting for server... ($i)"
            sleep 1
          done
          echo "❌ Server did not become healthy in time"
          cat server.log
          exit 1

      - name: Install test deps
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run HTTP MVP integration tests
        run: bash scripts/it_http_mvp.sh

      - name: Always show last server log lines
        if: always()
        run: |
          echo "---- tail server.log ----"
          tail -n 200 server.log || true

      - name: Upload server.log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: server-log
          path: server.log

      - name: Stop server
        if: always()
        shell: bash
        run: |
          if [ -f server.pid ]; then
            echo "Stopping server PID $(cat server.pid)"
            kill "$(cat server.pid)" || true
          else
            echo "No server.pid found, skipping stop"
          fi
